# 球谐光照

球谐光照在现在游戏图形渲染领域应用很广，用于快速的模拟复杂的实时光照，例如Unity的light probe以及一些不重要的实时光源，可以用球谐光照快速的计算。球谐光照的优点是运行时的计算量与光源的数量无关，可以较好的模拟实时的光照效果。

球谐光照的原理不仅涉及图形学，概率论，信号分析，微积分等大量复杂的数学公式，这里对这个球谐光照的北京和应用做个简单的理解。

# 拟合思想和球面谐调(spherical harmonic)

正交基底函数

了解信号处理中时域到频域转换的知道，有个叫做傅里叶变换的东西，即任何函数$f(x)$，我们都可以把他写成一组三角函数乘上系数之后的和，即$F(x)=\sum c \cdot f(x)$，这里的$f(x)$既是一组正交的基函数，这些基函数是正交意味着它们之间的互相积分是0，

球面调谐

# 球谐光照

$$L(x,)$$

首先基于物理的模型，我们认为从一个表面点反射到眼睛不是一条直线，而是一小块球面的光锥。该点的颜色既是这小块球面光锥的光子能量。

其中L表示从物体表面X点反射过来的w方向的光，Le代表这个点在w方向的自然光

例如在光照条件固定的情况下，我们可以对每个空间点附近的一个球面区域去真实的用公式计算一些采样点的值，然后用光照公式的采样曲线选定的几组球谐函数正交基底积分算出每个正交基底的参数，最后利用这些正交基底，即可以求出空间点球面上任意一个位置的光照，这就是光照探头的基本思想，即在光照固定的情况下先用真实光照方程采样，降低维度，用一组少量参数去计算任意位置的光照。

# Unity中的球谐光照应用

Unity中至少在光照探头和前向渲染的大量顶点光照这两个地方使用了球谐光照的技术。

光照探头：

Unity的光照探头在烘培的时候为每个探头点附近采样光照值，然后计算每个点的球谐函数基底函数，用于运行时对于动态物体计算当前点的烘培时的全局光照。

前向渲染中的实时顶点光照：

前向渲染中光源数量太多，会降低运行效率，Unity的Forward严格控制了光照的运算数量，具体的规则是，最亮的那盏直线光一定是像素光，其他标记了important的光源在数量不超过setting

我们可以简单看一下Unity的Shader，指出它对球谐光照的运算。

对于Unity内置Shader的Vertex Shader中有一个VertexGIForward函数，里面处理了发生在顶点时的光照，它只发生在base pass里面。

```c
inline half4 VertexGIForward(VertexInput v, float3 posWorld, half3 normalWorld)
{
    
}
```