---
title: C++中堆栈的区别
mathjax: true
date: 2019-04-02 18:12:03
tags:
    - C++
categories: C++
---

# 管理方式
堆中资源由代码控制（通过malloc/free、new/delete，容易产生memory leak），栈资源由编译器自动管理。

# 系统响应 
对于堆，系统有一个记录空闲内存地址的链表，当系统收到程序申请时，遍历该链表，寻找第一个大于所申请空间的堆结点，删除空闲链表中的该结点，并将该结点空间分配给程序（大多数系统会在这块内存空间首地址记录本次分配的大小，这样delete才能正确释放本内存空间，另外，系统会将多余的情况重新放入空闲链表中）。对于栈，只要占得剩余空间大于所申请空间，系统就会为程序分配内存，否则报异常出现栈溢出。

# 空间大小
堆是不连续的内存区域（因为系统使用链表来存储空闲内存地址的，自然不是连续），堆的大小受限于计算机系统中有效的虚拟内存（32位机器理论上是4G大小），所以堆的空间比较灵活，比较大。栈是一块连续的内存区域，大小是操作系统预定好的，windows下栈大小是2M（也有是1M，在编译时确定，VC中可设置）。

# 碎片问题
对于堆，频繁的new/delete会造成大量内存碎片化，降低程序效率，对于栈，它是一个先进后出（first-in-last-out）结构，进出一一对应，不会产生碎片化。

# 生长方向
堆向上，由高地址方向增长；栈向下，向低地址方向增长。

# 分配方式
堆是动态分配（没有静态分配的堆）。栈有静态分配和动态分配，静态分配由编译器完成（如函数局部变量），动态分配由allocal函数分配，但栈的动态分配资源由编译器自动释放，无需程序员实现。

# 分配效率
堆由C/C++函数库提供，机制很复杂，因此堆的效率比栈低很多。栈是机器系统提供的数据结构，计算机在底层对栈提供支持，分配专门的寄存器存放栈地址，提供栈操作专门的指令。